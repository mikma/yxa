From: Mikael Magnusson <mikma264@gmail.com>
Subject: [PATCH] t/feature/yxa_yaws_makefile

YXA embedded Yaws web server application makefile.

Signed-off-by: Mikael Magnusson <mikma@users.sourceforge.net>

---
 configure.ac         |   26 +++++++++++++++++++++++++-
 yaws/src/Makefile.in |   45 +++++++++++++++++++++++++++++++++++++++++----
 2 files changed, 66 insertions(+), 5 deletions(-)

diff --git a/configure.ac b/configure.ac
index 3858e7a..9fad5a5 100644
--- a/configure.ac
+++ b/configure.ac
@@ -8,6 +8,7 @@ AC_CONFIG_AUX_DIR([scripts])
 
 AC_PROG_CC
 AC_PROG_INSTALL
+PKG_PROG_PKG_CONFIG
 
 AC_ARG_WITH(erlang,
 	AC_HELP_STRING([--with-erlang=dir],
@@ -26,12 +27,35 @@ AC_ERLANG_NEED_ERLC
 AC_ERLANG_PATH_ERL
 AC_ERLANG_SUBST_INSTALL_LIB_DIR
 AC_ERLANG_SUBST_ERTS_VER
+
+AC_ARG_WITH(yaws,
+	[AC_HELP_STRING([--with-yaws],
+		[auto detect yaws [[default=yes]]])])
+
+has_yaws="no"
+case "$with_yaws" in
+    '')
+	dnl Auto-detect yaws
+	PKG_CHECK_MODULES([YAWS],[yaws >= 1.73],[has_yaws="yes"],[AC_MSG_RESULT([no])])
+	;;
+    yes)
+	dnl Require yaws
+	PKG_CHECK_MODULES([YAWS],[yaws >= 1.73],[has_yaws="yes"])
+	;;
+esac
+
+if test "$has_yaws" = "yes"; then
+    dnl Yaws found
+    ERLANG_LIB_VER_yaws=`${PKG_CONFIG} --modversion yaws`
+    AC_SUBST(ERLANG_LIB_VER_yaws)
+    ERLANG_LIB_VER_SUBST="$ERLANG_LIB_VER_SUBST -e 's,[@]ERLANG_LIB_VER_yaws[@],\$(ERLANG_LIB_VER_yaws),g'"
+fi
+
 ERLANG_SUBST_LIB_VER(asn1)
 ERLANG_SUBST_LIB_VER(kernel)
 ERLANG_SUBST_LIB_VER(mnesia)
 ERLANG_SUBST_LIB_VER(ssl)
 ERLANG_SUBST_LIB_VER(stdlib)
-ERLANG_SUBST_LIB_VER(yaws)
 ERLANG_SUBST_LIB_VER(crypto)
 ERLANG_SUBST_LIB_VER(public_key)
 
diff --git a/yaws/src/Makefile.in b/yaws/src/Makefile.in
index f14785c..478e7ee 100644
--- a/yaws/src/Makefile.in
+++ b/yaws/src/Makefile.in
@@ -18,8 +18,25 @@ exec_prefix=${prefix}
 builddir = @builddir@
 local_file = @local_file@
 
+datadir = @datadir@
+localstatedir = @localstatedir@
+
+ERLANG_LIB_VER_asn1 = @ERLANG_LIB_VER_asn1@
+ERLANG_LIB_VER_kernel = @ERLANG_LIB_VER_kernel@
+ERLANG_LIB_VER_mnesia = @ERLANG_LIB_VER_mnesia@
+ERLANG_LIB_VER_ssl = @ERLANG_LIB_VER_ssl@
+ERLANG_LIB_VER_stdlib = @ERLANG_LIB_VER_stdlib@
+ERLANG_LIB_VER_yaws = @ERLANG_LIB_VER_yaws@
+ERLANG_LIB_VER_SUBST = @ERLANG_LIB_VER_SUBST@
+
+docrootdir = $(datadir)/yxa/docroot
+tmpdir = $(localstatedir)/run/yxa
+logdir = $(localstatedir)/log/yxa
+
 ERLC = @ERLC@
 ERL = @ERL@
+YAWS_CFLAGS = @YAWS_CFLAGS@
+YAWS_LIBS = @YAWS_LIBS@
 
 INSTALL = @INSTALL@
 install_DATA = @INSTALL_DATA@
@@ -30,7 +47,13 @@ doc_dir = ../../doc
 
 mkinstalldirs = $(SHELL) $(top_srcdir)/scripts/mkinstalldirs
 
+systools_make_script = \
+	$(ERLC) -pa $(ebin_dir) $(YAWS_LIBS) -I$(srcdir) $(ebin_dir)/$*.rel
+
 erl_FILES = \
+	yxa_yaws_app.erl \
+	yxa_yaws_ctl.erl \
+	yxa_yaws_sup.erl \
 	yxa_yaws_util.erl
 
 imported_hrl_FILES = \
@@ -46,14 +69,20 @@ yxa_hrl_FILES = $(imported_hrl_FILES) $(hrl_FILES)
 CC = gcc
 CFLAGS = -Wall
 
+EFLAGS = -W +debug_info -DDOCROOT=\"$(docrootdir)\" -DCACHEDIR=\"$(tmpdir)\" -DLOGDIR=\"$(logdir)\" $(YAWS_CFLAGS)
+
 beam_FILES = $(addprefix $(ebin_dir)/, $(erl_FILES:.erl=.beam))
 
-all: $(beam_FILES)
+boot_FILES = yxa_yaws.boot
 
-install: $(beam_FILES) $(hrl_FILES)
+app_FILES = $(addprefix $(ebin_dir)/, $(boot_FILES:.boot=.app))
+
+all: $(beam_FILES) $(app_FILES) $(boot_FILES)
+
+install: $(beam_FILES) $(hrl_FILES) $(boot_FILES)
 	$(mkinstalldirs) $(DESTDIR)$(beamdir)
 	$(mkinstalldirs) $(DESTDIR)$(includedir)
-	for p in $(beam_FILES); do \
+	for p in $(beam_FILES) $(app_FILES) $(boot_FILES); do \
 	  $(install_DATA) $$p $(DESTDIR)$(beamdir)/$$f ; \
 	done
 	for p in $(hrl_FILES); do \
@@ -87,5 +116,13 @@ SUFFIXES = .c .o .hrl .beam .erl .boot .rel .rel-in .app .app-in
 .SUFFIXES: .c .o .hrl .beam .erl .boot .rel .rel-in .app .app-in
 
 $(ebin_dir)/%.beam:	$(srcdir)/%.erl
-	$(ERLC) -o $(ebin_dir) -I$(srcdir) -I$(top_srcdir)/src/include/ -W +debug_info $<
+	$(ERLC) -o $(ebin_dir) -I$(srcdir) -I$(top_srcdir)/src/include/ $(EFLAGS) $<
+
+$(ebin_dir)/%.app:	$(srcdir)/%.app-in
+	cp $< $@
+
+$(ebin_dir)/%.rel:	$(srcdir)/%.rel-in
+	sed $(ERLANG_LIB_VER_SUBST) $< > $@
 
+yxa_yaws.boot: $(ebin_dir)/yxa_yaws.app $(ebin_dir)/yxa_yaws.rel
+	$(systools_make_script)
-- 
tg: (aaf809c..) t/feature/yxa_yaws_makefile (depends on: upstream)
